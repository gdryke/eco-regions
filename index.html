<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shapefile on GitHub Pages</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .info { position: absolute; top: 10px; left: 10px; background: white; padding: 8px 10px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,.15); z-index: 1000; }
    .legend { 
      position: absolute; 
      bottom: 20px; 
      right: 20px; 
      background: white; 
      padding: 12px; 
      border-radius: 6px; 
      box-shadow: 0 2px 6px rgba(0,0,0,.15); 
      z-index: 1000;
      font-size: 12px;
      max-width: 250px;
    }
    .legend h4 { 
      margin: 0 0 8px 0; 
      font-size: 14px; 
      color: #2c3e50; 
    }
    .legend-item { 
      display: flex; 
      align-items: center; 
      margin: 4px 0; 
    }
    .legend-color { 
      width: 16px; 
      height: 16px; 
      margin-right: 8px; 
      border: 1px solid #666; 
      border-radius: 2px; 
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info">Click features to see ecoregion details</div>
  <div class="legend">
    <h4>EPA Level III Ecoregions</h4>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #E8D5A3;"></div>
      <span>Western Corn Belt Plains</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #B8D4E3;"></div>
      <span>Lake Agassiz Plain</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #A8D5A8;"></div>
      <span>Northern Lakes and Forests</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #D4B896;"></div>
      <span>North Central Hardwood Forests</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #F2E6B8;"></div>
      <span>Driftless Area</span>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <!-- shp.js parses zipped shapefiles in the browser -->
  <script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

  <script>
    // 1) Create a map
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 2) Load your zipped shapefile (served from the same repo to avoid CORS issues)
    // Put your file at /data/mn_eco_l4.zip
    shp('data/mn_eco_l4.zip').then(geojson => {
      // shp() returns GeoJSON or a FeatureCollection/array if multiple layers exist
      const asCollection = geojson.type === 'FeatureCollection'
        ? geojson
        : { type: 'FeatureCollection', features: Array.isArray(geojson) ? geojson : [geojson] };

      // 3) Add to map with symbology based on Level 3 ecoregions
      // Color scheme for Minnesota EPA Level 3 Ecoregions
      const getEcoregionStyle = (feature) => {
        const l3Code = feature.properties?.US_L3CODE || '';
        const l3Name = feature.properties?.US_L3NAME || '';
        
        // Color mapping based on EPA Level 3 Ecoregions
        const colorMap = {
          '47': '#E8D5A3', // Western Corn Belt Plains - light tan/beige
          '48': '#B8D4E3', // Lake Agassiz Plain - light blue 
          '50': '#A8D5A8', // Northern Lakes and Forests - light green
          '51': '#D4B896', // North Central Hardwood Forests - light brown
          '52': '#F2E6B8'  // Driftless Area - pale yellow
        };
        
        const fillColor = colorMap[l3Code] || '#CCCCCC'; // Default gray
        
        return {
          weight: 1.5,
          opacity: 0.8,
          color: '#666666',      // Border color
          fillColor: fillColor,
          fillOpacity: 0.6
        };
      };

      // Level 4 Ecoregion descriptions mapping
      const ecoregionDescriptions = {
        '46e': 'This ecoregion consists of stagnation moraines with knob-and-kettle topography and numerous small lakes and wetlands. The area has moderately well-drained to poorly drained soils supporting mixed grassland-agricultural landscape with scattered wetlands and small woodlots.',
        '46k': 'The Prairie Coteau is characterized by relatively high, gently rolling terrain with well-drained soils. This upland area supports native grasslands and agricultural crops, with numerous seasonal and semi-permanent wetlands in low-lying areas providing important waterfowl habitat.',
        '46l': 'This narrow transitional zone features steep slopes and escarpment edges between the Prairie Coteau and adjacent lowlands. The area has well-drained soils and supports a mix of native grassland, scattered trees, and agricultural use where topography permits.',
        '46m': 'The Big Sioux Basin consists of broad, gently sloping valleys and adjacent uplands with moderately well-drained soils. This area supports intensive agriculture, primarily corn and soybeans, with remnant prairie and wetland areas in less suitable agricultural locations.',
        '46o': 'This ecoregion encompasses the broad valley of the Minnesota River and adjacent terraces. The area has fertile, well-drained alluvial soils supporting intensive corn and soybean agriculture, with remnant prairie and wetland areas along the floodplain.',
        '47a': 'The Loess Prairies are characterized by wind-deposited silt (loess) over glacial till, creating fertile, well-drained soils. This area supports intensive agriculture, primarily corn and soybeans, with very few remaining natural areas due to the highly productive soils.',
        '47b': 'The Des Moines Lobe consists of young glacial till plains with relatively flat to gently rolling topography. This area has fertile, poorly to moderately well-drained soils supporting intensive agriculture, with numerous drained wetlands and prairie pothole remnants.',
        '47c': 'This ecoregion features older glacial till plains with more dissected topography than adjacent areas. The moderately well-drained soils support intensive agriculture, primarily corn and soybeans, with some remaining oak woodland and prairie remnants on steeper slopes.',
        '47g': 'These river valleys are characterized by alluvial terraces and floodplains with fertile, well-drained soils. The area supports intensive agriculture in suitable locations, with riparian forests, wetlands, and some remnant prairie areas along the major rivers.',
        '48a': 'This flat, poorly drained basin was the deepest part of glacial Lake Agassiz. The area has very fertile, dark soils supporting agriculture including sugar beets, potatoes, and small grains, with numerous drained wetlands and some remaining prairie pothole wetlands.',
        '48b': 'These ancient beach ridges and deltas of glacial Lake Agassiz create a distinctive landscape of parallel sandy ridges and wet swales. The area supports mixed agriculture and has numerous wetlands, with some remaining prairie and aspen woodland on sandy soils.',
        '48d': 'The Lake Agassiz Plains are flat, poorly drained areas with deep, fertile soils. This region supports intensive agriculture including sugar beets, potatoes, wheat, and corn, with extensive drainage systems and some remaining wetlands and grassland areas.',
        '49a': 'This ecoregion is dominated by extensive peatlands, bogs, and coniferous swamps formed in poorly drained depressions. The area supports black spruce, tamarack, and sphagnum moss communities, with limited human development due to wet conditions and peat soils.',
        '49b': 'This ecoregion, to the east and partially south of the Peatlands (49a), grades from sections of peat in the northwest to more forest in the northeast and forest along the undulating lobes of the wider southern part. Hemists soils are interspersed in small patches in a number of sections between larger areas of wet forest Aqualfs, and forest Udalfs which predominate in the south. The topography is relatively flat with a gentle rising gradient from the Rainy River on the northern border to elevations as much as 75 m higher in the south. There is some evidence of human landscape modification of vegetation but most land is forest or bog except for some cleared land along the Rainy River and south of it for 15 to 20 km along its tributaries, the Big and Little Fork Rivers, and in the area around International Falls. About 60% of this ecoregion was wetlands and 25% deciduous forest in 2013.',
        '50a': 'This ecoregion consists of flat to gently rolling clay plains formed by glacial Lake Duluth. The area has poorly to moderately well-drained clay soils supporting mixed coniferous-deciduous forests, with some agriculture in drier areas and extensive wetland complexes.',
        '50b': 'This upland area features rolling glacial till plains with moderately well-drained soils. The region supports mixed deciduous-coniferous forests dominated by aspen, birch, and conifers, with numerous lakes, wetlands, and some agricultural clearings in suitable areas.',
        '50m': 'The Mesabi Range consists of bedrock-controlled terrain with thin soils over iron formations. This area supports mixed coniferous-deciduous forests, has numerous small lakes and wetlands, and has been extensively modified by iron ore mining activities.',
        '50n': 'This ecoregion features rugged terrain with thin soils over bedrock, numerous lakes, and extensive forest cover. The area supports mixed coniferous-deciduous forests dominated by pine, aspen, and birch, with limited agricultural development due to rocky conditions.',
        '50o': 'These areas consist of broad lake plains formed by glacial lakes, with moderately well-drained to poorly drained soils. The region supports mixed forests, extensive wetland complexes, and some agricultural development in areas with suitable soils.',
        '50p': 'This ecoregion consists of distinctive streamlined hills (drumlins) with moderately well-drained soils. The area supports mixed coniferous-deciduous forests, has numerous small lakes and wetlands between drumlins, and some agricultural use in cleared areas.',
        '50q': 'These moraines consist of rolling to hilly terrain with moderately well-drained soils and numerous lakes. The area supports mixed coniferous-deciduous forests dominated by aspen, birch, and pine, with extensive wetlands and limited agricultural development.',
        '50r': 'The Chippewa Plains feature broad, flat to gently rolling glacial outwash plains with well-drained to moderately well-drained sandy soils. This area supports mixed pine-hardwood forests, has numerous small lakes and wetlands, and some agricultural use.',
        '50s': 'These moraines and uplands consist of rolling to hilly terrain with moderately well-drained soils. The region supports mixed coniferous-deciduous forests, numerous lakes and wetlands, and limited agricultural development due to rocky and uneven terrain.',
        '50t': 'The North Shore Highlands feature rugged terrain with thin soils over bedrock along Lake Superior. This area supports boreal coniferous forests dominated by spruce and fir, has limited agricultural potential, and includes scenic areas important for tourism.',
        '51a': 'These stagnation moraines consist of knob-and-kettle topography with moderately well-drained to poorly drained soils. The area supports deciduous and mixed forests dominated by maple, basswood, and oak, with numerous wetlands and some agricultural clearings.',
        '51h': 'This ecoregion consists of sandy outwash plains and terraces with well-drained soils. The area supports oak woodlands and prairies, has been extensively developed for urban and suburban use, and retains some natural areas in parks and preserves.',
        '51i': 'The Big Woods historically supported extensive deciduous forests on fertile, well-drained soils. This area has been largely converted to agriculture and urban development, with scattered remnants of maple-basswood forests in parks and preserves.',
        '51j': 'This ecoregion features rolling moraines and outwash plains with moderately well-drained to well-drained soils. The area supports mixed deciduous-coniferous forests and prairie, numerous lakes and wetlands, and agricultural use in suitable locations.',
        '51k': 'This ecoregion consists of till plains and drumlin fields with moderately well-drained soils. The area supports deciduous and mixed forests, has numerous small lakes and wetlands, and includes agricultural use in areas with suitable topography.',
        '51l': 'These drumlins and till plains feature rolling terrain with moderately well-drained soils. The region supports deciduous and mixed forests dominated by hardwoods, numerous lakes and wetlands, and agricultural development in cleared areas.',
        '52b': 'The Blufflands and Coulees feature deeply dissected terrain with steep slopes and narrow valleys that escaped glaciation. This area supports deciduous forests dominated by oak and maple, cold-water streams, and limited agricultural use due to steep topography.',
        '52c': 'This upland plateau consists of gently rolling terrain underlain by Paleozoic bedrock with thin soils. The area supports oak woodlands and prairies, has well-drained soils suitable for agriculture, and retains some natural areas on steeper slopes and rocky areas.'
      };

      const layer = L.geoJSON(asCollection, {
        style: getEcoregionStyle,
        onEachFeature: (feature, lyr) => {
          // Build a focused popup showing ecoregion hierarchy
          const props = feature.properties || {};
          const l4Code = props.US_L4CODE || '';
          const description = ecoregionDescriptions[l4Code] || 'Description not available for this ecoregion.';
          
          const popupContent = `
            <div style="max-width: 300px;">
              <h4 style="margin: 0 0 8px 0; color: #2c3e50;">${props.US_L4NAME || 'Unknown Level 4 Ecoregion'}</h4>
              <p style="margin: 4px 0; font-size: 12px;"><strong>Level 4 Code:</strong> ${props.US_L4CODE || 'N/A'}</p>
              <p style="margin: 4px 0; font-size: 12px;"><strong>Level 3:</strong> ${props.US_L3NAME || 'N/A'} (${props.US_L3CODE || 'N/A'})</p>
              <div style="margin-top: 12px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #007cba; border-radius: 3px;">
                <p style="margin: 0; font-size: 12px; line-height: 1.4; color: #2c3e50;">${description}</p>
              </div>
            </div>
          `;
          lyr.bindPopup(popupContent);
          
          // Enhanced hover effects
          lyr.on('mouseover', () => {
            lyr.setStyle({ 
              weight: 3, 
              opacity: 1,
              color: '#2c3e50'
            });
          });
          lyr.on('mouseout', () => {
            lyr.setStyle(getEcoregionStyle(feature));
          });
        }
      }).addTo(map);

      // 4) Fit the map to the data
      try { map.fitBounds(layer.getBounds(), { padding: [10,10] }); } catch (e) {}
    }).catch(err => {
      console.error(err);
      alert('Failed to load shapefile. See console for details.');
    });
  </script>
</body>
</html>

